YUI.add("moodle-atto_phonetic-button",function(a,t){var o="atto_phonetic",n={PHONETIC_TEXT:"atto_phonetic_phonetic",PHONETIC_PREVIEW:"atto_phonetic_preview",PHONETIC_PREVIEW_EACH_CHAR:"atto_phonetic_preview_each_char",PHONETIC_PREVIEW_TEXTAREA:"atto_phonetic_preview_textarea",SUBMIT:"atto_phonetic_submit",LIBRARY:"atto_phonetic_library",LIBRARY_GROUPS:"atto_phonetic_groups",LIBRARY_GROUP_PREFIX:"atto_phonetic_group",LIBRARY_BASE_SYMBOL:"atto_phonetic_base_symbol"},h={LIBRARY:"."+n.LIBRARY,LIBRARY_GROUP:"."+n.LIBRARY_GROUPS+" > div > div",PHONETIC_TEXT:"."+n.PHONETIC_TEXT,PHONETIC_PREVIEW:"."+n.PHONETIC_PREVIEW,PHONETIC_PREVIEW_EACH_CHAR:"."+n.PHONETIC_PREVIEW_EACH_CHAR,SUBMIT:"."+n.SUBMIT,LIBRARY_BUTTON:"."+n.LIBRARY+" button"},i={START:"",END:""},r='<form class="atto_form">{{{library}}}<label for="{{elementid}}_{{CSS.PHONETIC_PREVIEW}}">{{get_string "preview" component}}</label><div class="well well-small fullwidth {{CSS.PHONETIC_PREVIEW}}" ><div class="{{CSS.PHONETIC_PREVIEW_TEXTAREA}}""><textarea class="fullwidth {{CSS.PHONETIC_TEXT}}" id="{{elementid}}_{{CSS.PHONETIC_TEXT}}" rows="4"></textarea></div><div class="{{CSS.PHONETIC_PREVIEW_EACH_CHAR}}" id="{{elementid}}_{{CSS.PHONETIC_PREVIEW_EACH_CHAR}}"></div></div><div class="mdl-align"><br/><button class="{{CSS.SUBMIT}}">{{get_string "savephonetic" component}}</button></div></form>',s='<div class="{{CSS.LIBRARY}}"><ul>{{#each library}}<li><a href="#{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}">{{get_string groupname ../component}}</a></li>{{/each}}</ul><div class="{{CSS.LIBRARY_GROUPS}}">{{#each library}}<div id="{{../elementid}}_{{../CSS.LIBRARY_GROUP_PREFIX}}_{{@key}}"><div role="toolbar" data-tex="{{get_string groupname ../component}}">{{#split-phonetic "\n" elements}}<button tabindex="-1" data-tex="{{this}}" aria-label="{{this}}" title="{{this}}" >{{this}}</button>{{/split-phonetic}}</div>{{#if-phonetic groupname "librarygroup6"}}<div><label class="atto_phonetic_base_symbol">Base Symbol</label>&nbsp;<input size="1" type="text" id="combinatory_input" maxlength="1"/></div>{{/if-phonetic}}</div>{{/each}}</div></div>';a.namespace("M.atto_phonetic").Button=a.Base.create("button",a.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_groupFocus:null,_phoneticPatterns:[/\\\[([\S\s]+?)\\\]/],initializer:function(){this._groupFocus={},this.get("texfilteractive")&&(this.addButton({icon:"phonetic",iconComponent:o,callback:this._displayDialogue}),this.get("host").on("atto:selectionchanged",function(){var t,e=M.util.image_url("phonetic",o);this._resolvePhonetic()?(this.highlightButtons(),e=M.util.image_url("phonetic-highlight",o)):this.unHighlightButtons(),(t=a.one(".atto_phonetic_button .icon"))&&t.setAttribute("src",e)},this),this.editor.all("tex").each(function(t){var e=a.Node.create('<span class="wacka_wacka_ding_dong">'+t.get("text")+"</span>");t.replace(e)}))},_displayDialogue:function(){var t,e,n,i;this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection&&(t=this._resolvePhonetic(),e=this.getDialogue({headerContent:M.util.get_string("pluginname",o),focusAfterHide:!0,width:600,focusOnShowSelector:h.PHONETIC_TEXT}),n=this._getDialogueContent(),e.set("bodyContent",n),i=n.one(h.LIBRARY),new a.TabView({srcNode:i}).render(),e.show(),require(["core/event"],function(t){t.notifyFilterContentUpdated(e.get("boundingBox").getDOMNode())}),t&&n.one(h.PHONETIC_TEXT).set("text",t))},_resolvePhonetic:function(){var u,t=this.get("host").getSelectionParentNode(),h=this.get("host").getSelection(),_=!1;return!!this.get("host").isActive()&&(!!t&&(!(!h||0===h.length)&&(this.sourcePhonetic=null,h=h[0],u=a.one(t).get("text"),a.Array.find(this._phoneticPatterns,function(l){var t=u.match(new RegExp(l.source,"g"));if(t&&t.length)return a.Array.find(t,function(t){for(var e,n,i,o,r,a,s,c=0;-1!==u.indexOf(t,c);){if(n=(e=u.indexOf(t,c))+t.length,i=h.startOffset>=e&&h.startOffset<n,o=h.endOffset<=n&&h.endOffset>e,i&&o&&(r=t.match(l))&&r.length)return s=(a=u.indexOf(r[1],e))+r[1].length,_=r[1],this.sourcePhonetic={startOuterPosition:e,endOuterPosition:n,outerMatch:t,startInnerPosition:a,endInnerPosition:s,innerMatch:r},!0;c=n}},this)},this),!1!==_&&(_=_.trim()),_)))},_setPhonetic:function(t){var e,n,i,o,r;o=this.get("host"),t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),""!==(i=t.currentTarget.ancestor(".atto_form").one("textarea").get("value"))&&(o.setSelection(this._currentSelection),this.sourcePhonetic?(r=(n=(e=a.one(o.getSelectionParentNode())).get("text")).slice(0,this.sourcePhonetic.startInnerPosition)+i+n.slice(this.sourcePhonetic.endInnerPosition),e.set("text",r)):o.insertContentAtFocusPoint(i),this.markUpdated())},_throttle:function(n,i){var o=null;return function(){var t=this,e=arguments;clearTimeout(o),o=setTimeout(function(){n.apply(t,e)},i)}},_loadPreview:function(t){var e=t.currentTarget.getAttribute("data-tex"),n=t.currentTarget.get("parentNode").getAttribute("data-tex");"Combining"==n&&(e=e.substring(1,e.length)),t.preventDefault(),this._content.one(h.PHONETIC_PREVIEW_EACH_CHAR).setHTML(e)},_getDialogueContent:function(){var t=this._getLibraryContent(),e=a.Handlebars.compile(r);return this._content=a.Node.create(e({elementid:this.get("host").get("elementid"),component:o,library:t,texdocsurl:this.get("texdocsurl"),CSS:n})),this._content.all(h.LIBRARY_GROUP).each(function(t){this._setGroupTabFocus(t,t.one("button")),t.all("button a").setAttribute("tabindex","-1")},this),this._content.delegate("key",this._groupNavigation,"down:37,39",h.LIBRARY_BUTTON,this),this._content.one(h.SUBMIT).on("click",this._setPhonetic,this),this._content.delegate("click",this._selectLibraryItem,h.LIBRARY_BUTTON,this),this._content.delegate("mouseenter",this._loadPreview,h.LIBRARY_BUTTON,this),this._content},_groupNavigation:function(t){t.preventDefault();var e,n=t.currentTarget,i=n.get("parentNode"),o=i.all("button"),r=37!==t.keyCode?1:-1,a=o.indexOf(n);a<0&&(a=0),(a+=r)<0?a=o.size()-1:a>=o.size()&&(a=0),
e=o.item(a),this._setGroupTabFocus(i,e),e.focus()},_setGroupTabFocus:function(t,e){var n=t.generateID();"undefined"!=typeof this._groupFocus[n]&&this._groupFocus[n].setAttribute("tabindex","-1"),null!==e&&((this._groupFocus[n]=e).setAttribute("tabindex",0),t.setAttribute("aria-activedescendant",e.generateID()))},_selectLibraryItem:function(t){var e,n,i,o,r,a,s,c=t.currentTarget.getAttribute("data-tex"),l=0,u=t.currentTarget.get("parentNode").getAttribute("data-tex");t.preventDefault(),this._setGroupTabFocus(t.currentTarget.get("parentNode"),t.currentTarget),e=this._content.one(h.PHONETIC_PREVIEW_EACH_CHAR),i=(n=t.currentTarget.ancestor(".atto_form").one("textarea")).get("value"),o="",o=("Combining"==u?(c=c.substring(1,c.length),e.setHTML(c),""!=(r=document.getElementById("combinatory_input").value)&&(c=r+c)):e.setHTML(c),i+c),n.set("value",o),n.focus(),l=o.length,"number"==typeof(a=n.getDOMNode()).selectionStart?a.selectionStart=a.selectionEnd=l:"undefined"!=typeof a.createTextRange&&((s=a.createTextRange()).moveToPoint(l),s.select())},_getLibraryContent:function(){var t=a.Handlebars.compile(s),e=this.get("library");return a.Handlebars.registerHelper("split-phonetic",function(t,e,n){var i,o,r;if(void 0===t||void 0===e)return"";for(r="",i=e.trim().split(t);0<i.length;)o=i.shift().trim(),"group6"==n.data.key&&(o="X"+o),r+=n.fn(o);return r}),a.Handlebars.registerHelper("if-phonetic",function(t,e,n){return t===e?n.fn(this):n.inverse(this)}),t({elementid:this.get("host").get("elementid"),component:o,library:e,CSS:n,DELIMITERS:i})}},{ATTRS:{texfilteractive:{value:!0},contextid:{value:null},library:{value:{}},texdocsurl:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-event","io","event-valuechange","tabview","array-extras"]});